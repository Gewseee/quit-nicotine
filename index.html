<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отказ от никотина</title>
    <style>
        body { font-family: Arial; margin: 20px; text-align: center; }
        .container { max-width: 600px; margin: auto; padding: 20px; }
        button { padding: 10px 20px; margin: 10px; background: #4CAF50; color: white; border: none; }
        input { padding: 8px; margin: 5px; width: 200px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Отказ от никотина</h1>
        <div id="auth" style="display: block;">
            <h2>Авторизация</h2>
            <input type="text" id="username" placeholder="Ник">
            <input type="password" id="password" placeholder="Пароль">
            <button onclick="login()">Войти</button>
            <button onclick="register()">Зарегистрироваться</button>
        </div>
        <div id="start" style="display: none;">
            <p>Что бросаешь?</p>
            <button onclick="alert('Парить')">Парить</button>
            <button onclick="alert('Курить')">Курить</button>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        const KEY = 'myFixedKey123';
        const TOKEN = ''; // Токен не нужен

        async function fetchUsers() {
            let r = await fetch('https://raw.githubusercontent.com/Gewseee/quit-nicotine/main/users.json');
            let u = await r.json();
            let d = {};
            for (let k in u) d[CryptoJS.AES.decrypt(k, KEY).toString(CryptoJS.enc.Utf8)] = true;
            return d;
        }

        async function saveUsers(u) {
            let e = {};
            for (let k in u) e[CryptoJS.AES.encrypt(k, KEY).toString()] = true;
            let c = btoa(JSON.stringify(e));
            let d = await fetch('https://api.github.com/repos/Gewseee/quit-nicotine/contents/users.json', {
                method: 'PUT',
                headers: { 'Authorization': `token ${TOKEN}` },
                body: JSON.stringify({ message: 'Update users', content: c, sha: (await fetch('https://api.github.com/repos/Gewseee/quit-nicotine/contents/users.json').then(r => r.json())).sha })
            });
            // Замени на пуш с сообщением
            let commitMsg = prompt('Введите ник:пароль для регистрации (например, user1:pass1)');
            await fetch('https://api.github.com/repos/Gewseee/quit-nicotine/contents/users.json', {
                method: 'PUT',
                headers: { 'Authorization': `token ${TOKEN}` },
                body: JSON.stringify({ message: commitMsg, content: c, sha: (await fetch('https://api.github.com/repos/Gewseee/quit-nicotine/contents/users.json').then(r => r.json())).sha })
            });
        }

        async function register() {
            let u = document.getElementById('username').value;
            let p = document.getElementById('password').value;
            if (!u || !p) return alert('Введите ник и пароль!');
            let us = await fetchUsers();
            let k = u + ':' + p;
            if (us[k]) return alert('Аккаунт есть!');
            us[k] = true;
            await saveUsers(us);
            alert('Зарегистрирован!');
        }

        async function login() {
            let u = document.getElementById('username').value;
            let p = document.getElementById('password').value;
            if (!u || !p) return alert('Введите ник и пароль!');
            let us = await fetchUsers();
            let k = u + ':' + p;
            if (us[k]) {
                localStorage.setItem('currentUser', k);
                document.getElementById('auth').style.display = 'none';
                document.getElementById('start').style.display = 'block';
            } else alert('Неверно!');
        }
    </script>
</body>
</html>
