<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отказ от никотина</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
        .container { max-width: 600px; margin: auto; padding: 20px; }
        button { padding: 10px 20px; margin: 10px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        input { padding: 8px; margin: 5px; width: 200px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Отказ от никотина</h1>
        <div id="auth" style="display: block;">
            <h2>Авторизация</h2>
            <input type="text" id="username" placeholder="Ник">
            <input type="password" id="password" placeholder="Пароль">
            <button onclick="login()">Войти</button>
            <button onclick="register()">Зарегистрироваться</button>
        </div>
        <div id="start" style="display: none;">
            <p>Что ты бросаешь?</p>
            <button onclick="alert('Парить')">Парить</button>
            <button onclick="alert('Курить')">Курить</button>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        const KEY = 'myFixedKey123'; // Фиксированный ключ
        const TOKEN = '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'; // Твой токен
        const REPO_URL = 'https://raw.githubusercontent.com/Gewseee/quit-nicotine/main/users.json';
        const API_URL = 'https://api.github.com/repos/Gewseee/quit-nicotine/contents/users.json';

        async function fetchUsers() {
            try {
                let response = await fetch(REPO_URL);
                let users = await response.json();
                let decryptedUsers = {};
                for (let userKey in users) {
                    let decrypted = CryptoJS.AES.decrypt(userKey, KEY).toString(CryptoJS.enc.Utf8);
                    decryptedUsers[decrypted] = true;
                }
                return decryptedUsers;
            } catch (e) {
                return {};
            }
        }

        async function saveUsers(users) {
            let encryptedUsers = {};
            for (let key in users) {
                encryptedUsers[CryptoJS.AES.encrypt(key, KEY).toString()] = true;
            }
            let content = btoa(unescape(encodeURIComponent(JSON.stringify(encryptedUsers))));
            let existingSha = await fetch(API_URL, {
                headers: { 'Authorization': `token ${TOKEN}` }
            }).then(res => res.json()).then(data => data.sha);

            await fetch(API_URL, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: 'Update users.json',
                    content: content,
                    sha: existingSha
                })
            });
        }

        async function register() {
            let username = document.getElementById('username').value;
            let password = document.getElementById('password').value;
            if (!username || !password) return alert('Введите ник и пароль!');
            let users = await fetchUsers();
            let userKey = username + ':' + password;
            if (users[userKey]) return alert('Такой аккаунт есть!');
            users[userKey] = true;
            await saveUsers(users);
            alert('Зарегистрирован!');
        }

        async function login() {
            let username = document.getElementById('username').value;
            let password = document.getElementById('password').value;
            if (!username || !password) return alert('Введите ник и пароль!');
            let users = await fetchUsers();
            let userKey = username + ':' + password;
            if (users[userKey]) {
                localStorage.setItem('currentUser', userKey);
                document.getElementById('auth').style.display = 'none';
                document.getElementById('start').style.display = 'block';
            } else alert('Неверный ник или пароль!');
        }
    </script>
</body>
</html>
