<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отказ от никотина</title>
    <style>
        body { font-family: Arial; margin: 20px; text-align: center; }
        .container { max-width: 600px; margin: auto; padding: 20px; }
        button { padding: 10px 20px; margin: 10px; background: #4CAF50; color: white; border: none; }
        input { padding: 8px; margin: 5px; width: 200px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Отказ от никотина</h1>
        <div id="auth" style="display: block;">
            <h2>Авторизация</h2>
            <input type="text" id="username" placeholder="Ник">
            <input type="password" id="password" placeholder="Пароль">
            <button onclick="login()">Войти</button>
            <button onclick="register()">Зарегистрироваться</button>
        </div>
        <div id="start" style="display: none;">
            <p>Что бросаешь?</p>
            <button onclick="alert('Парить')">Парить</button>
            <button onclick="alert('Курить')">Курить</button>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        const KEY = 'X7k9P2mQ8jL5vR4tY3zW6bH1nJ4kQ9';
        const TOKEN = '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'; // Вставь свой токен
        const API_URL = 'https://api.github.com/repos/Gewseee/quit-nicotine/contents/users.json';

        async function fetchUsers() {
            try {
                let response = await fetch('https://raw.githubusercontent.com/Gewseee/quit-nicotine/main/users.json');
                let users = await response.json();
                let decrypted = {};
                for (let k in users) decrypted[CryptoJS.AES.decrypt(k, KEY).toString(CryptoJS.enc.Utf8)] = true;
                return decrypted;
            } catch { return {}; }
        }

        async function saveUsers(users) {
            let encrypted = {};
            for (let k in users) encrypted[CryptoJS.AES.encrypt(k, KEY).toString()] = true;
            let content = btoa(JSON.stringify(encrypted));
            let data = await fetch(API_URL, { headers: { 'Authorization': `token ${TOKEN}` } }).then(r => r.json());
            await fetch(API_URL, {
                method: 'PUT',
                headers: { 'Authorization': `token ${TOKEN}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: 'Update users', content, sha: data.sha })
            });
        }

        async function register() {
            let u = document.getElementById('username').value;
            let p = document.getElementById('password').value;
            if (!u || !p) return alert('Введите ник и пароль!');
            let users = await fetchUsers();
            let key = u + ':' + p;
            if (users[key]) return alert('Аккаунт есть!');
            users[key] = true;
            await saveUsers(users);
            alert('Зарегистрирован!');
        }

        async function login() {
            let u = document.getElementById('username').value;
            let p = document.getElementById('password').value;
            if (!u || !p) return alert('Введите ник и пароль!');
            let users = await fetchUsers();
            let key = u + ':' + p;
            if (users[key]) {
                localStorage.setItem('currentUser', key);
                document.getElementById('auth').style.display = 'none';
                document.getElementById('start').style.display = 'block';
            } else alert('Неверно!');
        }
    </script>
</body>
</html>
